name: Claude Fix

on:
  issues:
    types: [labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to fix'
        required: true
        type: number
      branch_name:
        description: 'Branch name (optional, auto-generated if empty)'
        required: false
        type: string

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

jobs:
  check-label:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event.label.name == 'claude-fix'
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      issue_number: ${{ steps.check.outputs.issue_number }}
      issue_title: ${{ steps.check.outputs.issue_title }}
      issue_body: ${{ steps.check.outputs.issue_body }}
    steps:
      - name: Check if should run
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ISSUE_NUMBER="${{ inputs.issue_number }}"
          else
            ISSUE_NUMBER="${{ github.event.issue.number }}"
          fi

          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT

          # Get issue details
          ISSUE_JSON=$(gh api repos/${{ github.repository }}/issues/$ISSUE_NUMBER)
          ISSUE_TITLE=$(echo "$ISSUE_JSON" | jq -r '.title')
          ISSUE_BODY=$(echo "$ISSUE_JSON" | jq -r '.body')
          ISSUE_STATE=$(echo "$ISSUE_JSON" | jq -r '.state')

          # Check if issue is open
          if [ "$ISSUE_STATE" != "open" ]; then
            echo "Issue #$ISSUE_NUMBER is not open, skipping"
            echo "should_run=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "should_run=true" >> $GITHUB_OUTPUT
          echo "issue_title=$ISSUE_TITLE" >> $GITHUB_OUTPUT

          # Store body in a file to handle multiline content
          echo "$ISSUE_BODY" > /tmp/issue_body.txt

      - name: Upload issue body
        if: steps.check.outputs.should_run == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: issue-body
          path: /tmp/issue_body.txt
          retention-days: 1

  claude-fix:
    needs: check-label
    runs-on: ubuntu-latest
    if: needs.check-label.outputs.should_run == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download issue body
        uses: actions/download-artifact@v7
        with:
          name: issue-body
          path: /tmp

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24.14.0'

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25.7'

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Create branch
        id: branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER="${{ needs.check-label.outputs.issue_number }}"

          if [ -n "${{ inputs.branch_name }}" ]; then
            BRANCH_NAME="${{ inputs.branch_name }}"
          else
            # Generate branch name from issue number and timestamp
            BRANCH_NAME="claude-fix/issue-${ISSUE_NUMBER}-$(date +%Y%m%d%H%M%S)"
          fi

          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b "$BRANCH_NAME"

      - name: Add processing comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER="${{ needs.check-label.outputs.issue_number }}"
          BRANCH_NAME="${{ steps.branch.outputs.branch_name }}"

          gh issue comment "$ISSUE_NUMBER" --body "## Claude Fix Started

          I'm analyzing this issue and working on a fix.

          **Branch:** \`$BRANCH_NAME\`
          **Started:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          **Run:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          I'll update this issue when the PR is ready for review."

      - name: Run Claude to fix issue
        id: claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          ISSUE_NUMBER="${{ needs.check-label.outputs.issue_number }}"
          ISSUE_TITLE="${{ needs.check-label.outputs.issue_title }}"
          ISSUE_BODY=$(cat /tmp/issue_body.txt)

          # Create prompt for Claude
          cat > /tmp/claude_prompt.txt << 'PROMPT_EOF'
          You are fixing a GitHub issue for the Fluxbase project. Here are the issue details:

          **Issue #ISSUE_NUMBER_PLACEHOLDER: ISSUE_TITLE_PLACEHOLDER**

          ISSUE_BODY_PLACEHOLDER

          ---

          Please analyze this issue and implement a fix. Follow these steps:

          1. Read and understand the issue description and acceptance criteria
          2. Explore the codebase to find the relevant files
          3. Implement the fix following the project's coding standards
          4. Add or update tests if applicable
          5. Ensure your changes don't break existing functionality

          Important guidelines:
          - Follow the patterns in CLAUDE.md
          - Run `make test` to verify your changes
          - Keep changes minimal and focused on the issue
          - Add comments only where the code isn't self-explanatory

          When you're done, commit your changes with a descriptive message that references the issue.
          PROMPT_EOF

          # Replace placeholders
          sed -i "s/ISSUE_NUMBER_PLACEHOLDER/$ISSUE_NUMBER/g" /tmp/claude_prompt.txt
          sed -i "s/ISSUE_TITLE_PLACEHOLDER/$ISSUE_TITLE/g" /tmp/claude_prompt.txt

          # Handle multiline body replacement
          ESCAPED_BODY=$(echo "$ISSUE_BODY" | sed ':a;N;$!ba;s/\n/\\n/g' | sed 's/[&/\]/\\&/g')
          sed -i "s/ISSUE_BODY_PLACEHOLDER/$ESCAPED_BODY/g" /tmp/claude_prompt.txt

          # Run Claude Code
          PROMPT=$(cat /tmp/claude_prompt.txt)

          claude --print --dangerously-skip-permissions "$PROMPT" 2>&1 | tee /tmp/claude_output.txt

          # Check if there were any commits
          if git log --oneline origin/main..HEAD | grep -q .; then
            echo "changes_made=true" >> $GITHUB_OUTPUT
          else
            echo "changes_made=false" >> $GITHUB_OUTPUT
          fi

      - name: Push changes
        if: steps.claude.outputs.changes_made == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="${{ steps.branch.outputs.branch_name }}"
          git push -u origin "$BRANCH_NAME"

      - name: Create Pull Request
        if: steps.claude.outputs.changes_made == 'true'
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER="${{ needs.check-label.outputs.issue_number }}"
          ISSUE_TITLE="${{ needs.check-label.outputs.issue_title }}"
          BRANCH_NAME="${{ steps.branch.outputs.branch_name }}"

          # Get commit messages for PR body
          COMMITS=$(git log --oneline origin/main..HEAD)

          PR_BODY=$(cat << EOF
          ## Summary

          Automated fix for #${ISSUE_NUMBER}: ${ISSUE_TITLE}

          ## Changes

          \`\`\`
          ${COMMITS}
          \`\`\`

          ## Related Issues

          Fixes #${ISSUE_NUMBER}

          ## Type of Change

          - [x] Bug fix (non-breaking change that fixes an issue)

          ## Testing

          - [ ] Unit tests added/updated
          - [ ] Manual testing performed

          ## Checklist

          - [x] Code follows the project's style guidelines
          - [ ] Self-review performed
          - [ ] Tests pass locally

          ---

          **This PR was automatically generated by Claude AI.**
          Please review carefully before merging.

          [View Claude's work log](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF
          )

          PR_URL=$(gh pr create \
            --title "fix: ${ISSUE_TITLE} (auto-fix for #${ISSUE_NUMBER})" \
            --body "$PR_BODY" \
            --base main \
            --head "$BRANCH_NAME" \
            --label "claude-generated" \
            --label "needs-review")

          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT

          # Extract PR number
          PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

      - name: Update issue with PR link
        if: steps.claude.outputs.changes_made == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER="${{ needs.check-label.outputs.issue_number }}"
          PR_URL="${{ steps.pr.outputs.pr_url }}"

          gh issue comment "$ISSUE_NUMBER" --body "## Fix Complete

          I've created a pull request with the proposed fix:

          **Pull Request:** ${PR_URL}

          Please review the changes and provide feedback. The PR will need to be approved before merging.

          ---

          If the fix doesn't fully address the issue or needs changes:
          1. Add comments on the PR with specific feedback
          2. I can make additional changes if you re-run the workflow"

      - name: Handle no changes
        if: steps.claude.outputs.changes_made == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER="${{ needs.check-label.outputs.issue_number }}"

          gh issue comment "$ISSUE_NUMBER" --body "## Unable to Create Fix

          I analyzed the issue but was unable to make any changes. This could mean:

          1. The issue needs more specific details about what to fix
          2. The fix requires architectural decisions that need human input
          3. I couldn't locate the relevant code

          **Claude's Analysis:**
          \`\`\`
          $(tail -100 /tmp/claude_output.txt)
          \`\`\`

          Please provide more context or consider fixing this manually."

          # Remove the claude-fix label to prevent re-runs
          gh issue edit "$ISSUE_NUMBER" --remove-label "claude-fix" || true

      - name: Handle failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER="${{ needs.check-label.outputs.issue_number }}"

          gh issue comment "$ISSUE_NUMBER" --body "## Fix Failed

          The automated fix workflow encountered an error.

          **Run:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          Please check the workflow logs for details and consider fixing manually."

          # Remove the claude-fix label
          gh issue edit "$ISSUE_NUMBER" --remove-label "claude-fix" || true
